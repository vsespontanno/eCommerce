name: eCommerce Microservices CI/CD

on:
  push:
    branches: [ main, deploy, check ]
  pull_request:
    branches: [ main ]

env:
  GO_VERSION: '1.23'
  # Yandex Container Registry
  REGISTRY: cr.yandex/${{ secrets.YC_REGISTRY_ID }}
  IMAGE_PREFIX: ecommerce

jobs:
  # Job 1: Lint and Test
  lint-and-test:
    name: Lint & Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: go.sum

      - name: Install dependencies
        run: go mod download

      - name: Verify dependencies
        run: go mod verify

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v6
        with:
          version: latest
          args: --timeout=5m --config=.golangci.yml
          skip-cache: false

      # Ñ‚ĞµÑÑ‚Ğ¾Ğ² Ğ¿Ğ¾ĞºĞ° Ğ½Ğµ Ğ½Ğ°Ğ¼ĞµÑ‡ĞµÑ‚Ñ :)
      # - name: Run tests
      #   run: |
      #     go test -v -race -coverprofile=coverage.out -covermode=atomic ./...
      #     go tool cover -func=coverage.out

      # - name: Upload coverage to Codecov
      #   uses: codecov/codecov-action@v4
      #   with:
      #     file: ./coverage.out
      #     flags: unittests
      #     name: codecov-umbrella
      #     fail_ci_if_error: false

  # Job 2: Check Yandex Container Registry Access
  # DISABLED: Yandex Container Registry is not available
  # check-ycr-access:
  #   name: Check YCR Access
  #   runs-on: ubuntu-latest
  #   needs: lint-and-test
  #   if: github.event_name == 'push'
    
  #   steps:
  #     - name: Install Yandex Cloud CLI
  #       run: |
  #         curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash
  #         echo "$HOME/yandex-cloud/bin" >> $GITHUB_PATH
  #
  #     - name: Configure Yandex Cloud CLI
  #       run: |
  #         $HOME/yandex-cloud/bin/yc config profile create ci-profile
  #         $HOME/yandex-cloud/bin/yc config set token ${{ secrets.YC_OAUTH_TOKEN }}
  #         $HOME/yandex-cloud/bin/yc config set cloud-id ${{ secrets.YC_CLOUD_ID }}
  #         $HOME/yandex-cloud/bin/yc config set folder-id ${{ secrets.YC_FOLDER_ID }}
  #
  #     - name: Verify Container Registry access
  #       run: |
  #         echo "ğŸ” Checking Yandex Container Registry access..."
  #
  #         # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ‡Ñ‚Ğ¾ registry ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚ Ğ² ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ½Ğ¾Ğ¼ folder
  #         $HOME/yandex-cloud/bin/yc container registry get ${{ secrets.YC_REGISTRY_ID }} \
  #           --folder-id ${{ secrets.YC_CONTAINER_FOLDER_ID }}
  #
  #         echo "âœ… Container Registry access verified"
  #         echo "ğŸ“¦ Registry ID: ${{ secrets.YC_REGISTRY_ID }}"
  #         echo "ğŸ“ Folder ID: ${{ secrets.YC_CONTAINER_FOLDER_ID }}"
  #
  #     - name: Test Docker login to YCR
  #       run: |
  #         echo "ğŸ” Testing Docker login to Yandex Container Registry..."
  #
  #         # Ğ›Ğ¾Ğ³Ğ¸Ğ½Ğ¸Ğ¼ÑÑ Ğ² YCR
  #         echo '${{ secrets.YC_REGISTRY_KEY }}' | docker login \
  #           --username json_key \
  #           --password-stdin \
  #           cr.yandex
  #
  #         echo "âœ… Docker login successful"

  # Job 3: Build and Push Docker Images
  # DISABLED: Yandex Container Registry is not available
  # build-and-push:
  #   name: Build & Push Docker Images
  #   runs-on: ubuntu-latest
  #   needs: check-ycr-access
  #   if: github.event_name == 'push'
    
  #   outputs:
  #     image-tag: ${{ steps.tag.outputs.image-tag }}
  #
  #   strategy:
  #     matrix:
  #       service:
  #         - name: sso-service
  #           dockerfile: services/sso-service/Dockerfile
  #           context: .
  #         - name: products-service
  #           dockerfile: services/products-service/Dockerfile
  #           context: .
  #         - name: wallet-service
  #           dockerfile: services/wallet-service/Dockerfile
  #           context: .
  #         - name: cart-service
  #           dockerfile: services/cart-service/Dockerfile
  #           context: .
  #         - name: order-service
  #           dockerfile: services/order-service/Dockerfile
  #           context: .
  #         - name: saga-orchestrator
  #           dockerfile: services/saga-orchestrator/Dockerfile
  #           context: .
  #         - name: migrations
  #           dockerfile: migrations/Dockerfile
  #           context: migrations
  #
  #   permissions:
  #     contents: read
  #     packages: write
  #
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #
  #     - name: Set up Docker Buildx
  #       uses: docker/setup-buildx-action@v3
  #
  #     - name: Log in to Yandex Container Registry
  #       uses: docker/login-action@v3
  #       with:
  #         registry: cr.yandex
  #         username: json_key
  #         password: ${{ secrets.YC_REGISTRY_KEY }}
  #
  #     - name: Generate image tag
  #       id: tag
  #       run: |
  #         # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ ĞºĞ¾Ñ€Ğ¾Ñ‚ĞºĞ¸Ğ¹ SHA Ğ´Ğ»Ñ Ñ‚ĞµĞ³Ğ°
  #         SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
  #         IMAGE_TAG="${SHORT_SHA}"
  #         echo "image-tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
  #         echo "ğŸ“¦ Image tag: ${IMAGE_TAG}"
  #
  #     - name: Extract metadata
  #       id: meta
  #       uses: docker/metadata-action@v5
  #       with:
  #         images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-${{ matrix.service.name }}
  #         tags: |
  #           type=raw,value=${{ steps.tag.outputs.image-tag }}
  #           type=raw,value=latest,enable={{is_default_branch}}
  #
  #     - name: Build and push Docker image
  #       uses: docker/build-push-action@v6
  #       with:
  #         context: ${{ matrix.service.context }}
  #         file: ${{ matrix.service.dockerfile }}
  #         push: true
  #         tags: ${{ steps.meta.outputs.tags }}
  #         labels: ${{ steps.meta.outputs.labels }}
  #         cache-from: type=gha
  #         cache-to: type=gha,mode=max
  #         platforms: linux/amd64

  # Job 4: Update Kustomize manifests
  # DISABLED: Yandex Container Registry is not available
  # update-manifests:
  #   name: Update Kustomize Manifests
  #   runs-on: ubuntu-latest
  #   needs: build-and-push
  #   if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #       with:
  #         token: ${{ secrets.PAT_TOKEN }}
  #         fetch-depth: 0
  #
  #     - name: Get image tag from build job
  #       id: get-tag
  #       run: |
  #         # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ñ‚ĞµĞ³ Ğ¸Ğ· build-and-push job
  #         echo "image-tag=${{ needs.build-and-push.outputs.image-tag }}" >> $GITHUB_OUTPUT
  #         echo "ğŸ“¦ Using image tag: ${{ needs.build-and-push.outputs.image-tag }}"
  #
  #     - name: Install kustomize
  #       run: |
  #         curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
  #         sudo mv kustomize /usr/local/bin/
  #         kustomize version
  #
  #     - name: Update kustomization.yaml files
  #       run: |
  #         IMAGE_TAG="${{ steps.get-tag.outputs.image-tag }}"
  #         echo "ğŸ”„ Updating kustomization.yaml files with tag: ${IMAGE_TAG}"
  #
  #         # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ ÑĞµÑ€Ğ²Ğ¸Ñ
  #         for service in sso-service products-service wallet-service cart-service saga-orchestrator order-service; do
  #           KUSTOMIZE_FILE="deploy/k8s/services/${service}/kustomization.yaml"
  #           if [ -f "$KUSTOMIZE_FILE" ]; then
  #             echo "ğŸ“ Updating ${service}..."
  #             cd "deploy/k8s/services/${service}"
  #             kustomize edit set image "cr.yandex/${{ secrets.YC_REGISTRY_ID }}/ecommerce-${service}:${IMAGE_TAG}"
  #             cd -
  #           fi
  #         done
  #
  #         echo "âœ… All kustomization.yaml files updated"
  #
  #     - name: Commit and push changes
  #       run: |
  #         git config --global user.name "GitHub Actions Bot"
  #         git config --global user.email "actions@github.com"
  #
  #         git add deploy/k8s/services/*/kustomization.yaml
  #
  #         if git diff --staged --quiet; then
  #           echo "â„¹ï¸ No changes to commit"
  #         else
  #           git commit -m "chore: update image tags to ${{ steps.get-tag.outputs.image-tag }} [skip ci]"
  #           git push
  #           echo "âœ… Changes committed and pushed"
  #         fi

  # Job 5: Security Scan
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: lint-and-test
    
    permissions:
      contents: read
      security-events: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Run Gosec Security Scanner
        run: |
          go install github.com/securego/gosec/v2/cmd/gosec@latest
          export PATH=$PATH:$(go env GOPATH)/bin
          gosec -no-fail -fmt sarif -out gosec-results.sarif ./...
        continue-on-error: true

      - name: Upload Gosec results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always() && hashFiles('gosec-results.sarif') != ''
        with:
          sarif_file: 'gosec-results.sarif'
  
  # Job 6: Notify Build Status
  notify:
    name: Notify Build Status
    runs-on: ubuntu-latest
    needs: [lint-and-test, security-scan]
    # DISABLED: check-ycr-access, build-and-push, update-manifests
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine build status
        id: status
        run: |
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ²ÑĞµ ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡Ğ½Ñ‹Ğµ Ğ´Ğ¶Ğ¾Ğ±Ñ‹
          LINT_TEST="${{ needs.lint-and-test.result }}"
          SECURITY="${{ needs.security-scan.result }}"
          
          # SUCCESS Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ĞµÑĞ»Ğ¸ Ğ²ÑĞµ ÑƒÑĞ¿ĞµÑˆĞ½Ñ‹
          if [ "$LINT_TEST" == "success" ] && [ "$SECURITY" == "success" ]; then
            echo "status=âœ… SUCCESS" >> $GITHUB_OUTPUT
            echo "emoji=ğŸ‰" >> $GITHUB_OUTPUT
            echo "color=success" >> $GITHUB_OUTPUT
          else
            echo "status=âŒ FAILED" >> $GITHUB_OUTPUT
            echo "emoji=ğŸš¨" >> $GITHUB_OUTPUT
            echo "color=failure" >> $GITHUB_OUTPUT
          fi

      - name: Send Telegram notification
        uses: appleboy/telegram-action@master
        continue-on-error: true
        timeout-minutes: 2
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          format: markdown
          message: |
            ${{ steps.status.outputs.emoji }} *eCommerce CI/CD Build ${{ steps.status.outputs.status }}*
            
            ğŸ“¦ *Repository:* `${{ github.repository }}`
            ğŸŒ¿ *Branch:* `${{ github.ref_name }}`
            ğŸ‘¤ *Author:* ${{ github.actor }}
            ğŸ’¬ *Commit:* `${{ github.event.head_commit.message }}`
            ğŸ”— *Commit SHA:* `${{ github.sha }}`
            
            ğŸ“Š *Job Results:*
            â€¢ Lint & Test: ${{ needs.lint-and-test.result == 'success' && 'âœ…' || 'âŒ' }}
            â€¢ Security Scan: ${{ needs.security-scan.result == 'success' && 'âœ…' || 'âŒ' }}
            
            âš ï¸ *Docker build and deployment jobs are disabled*
            
            ğŸ”— [View Workflow Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})