apiVersion: batch/v1
kind: Job
metadata:
  name: db-migrations
  namespace: ecommerce
spec:
  # –ù–µ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–≤–∞—Ç—å Job –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –æ—à–∏–±–∫–µ
  backoffLimit: 3
  
  template:
    metadata:
      labels:
        app: db-migrations
    spec:
      restartPolicy: Never
      
      containers:
        - name: goose-migrations
          # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ–±—Ä–∞–Ω–Ω—ã–π –æ–±—Ä–∞–∑ —Å –º–∏–≥—Ä–∞—Ü–∏—è–º–∏
          image: cr.yandex/crphjp07nodds7bvd5ar/ecommerce-migrations:latest
          
          command:
            - /bin/sh
            - -c
            - |
              echo "üîÑ Running database migrations..."
              goose -dir /migrations postgres \
                "host=${PG_HOST} port=${PG_PORT} user=${PG_USER} password=${PG_PASSWORD} dbname=${PG_NAME} sslmode=disable" \
                up
              echo "‚úÖ Migrations completed successfully"
          
          # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–∑ ConfigMap –∏ Secret
          env:
            - name: PG_HOST
              valueFrom:
                configMapKeyRef:
                  name: sso-service-config
                  key: PG_HOST
            - name: PG_PORT
              valueFrom:
                configMapKeyRef:
                  name: sso-service-config
                  key: PG_PORT
            - name: PG_NAME
              valueFrom:
                configMapKeyRef:
                  name: sso-service-config
                  key: PG_NAME
            - name: PG_USER
              valueFrom:
                configMapKeyRef:
                  name: sso-service-config
                  key: PG_USER
            - name: PG_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: sso-service-secret
                  key: PG_PASSWORD
      
      # imagePullSecret –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ YCR
      imagePullSecrets:
        - name: yc-registry-secret